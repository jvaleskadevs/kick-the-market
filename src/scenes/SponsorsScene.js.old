import { keccak256, toHex } from 'viem';

export class SponsorsScene extends Phaser.Scene {
  constructor() {
    super('SponsorsScene');
    this.account = null;
    this.isInitialized = false;
    this.selectedTier = 'bronze';
    this.form = {
      name: '',
      description: '',
      cta: '',
      logoUrl: '',
      website: ''
    };
    this.previewContainer = null;
    this.mockLogoUrl = 'ipfs://';
  }

  init(data) {
    this.setSponsorParams = window.phaserGame?.web3Data?.setSponsorParams || null;
    this.isTouchable = this.sys.game.device.input.touch;
  }

  create() {
    this.addEventListeners();
    this.setupUI();
    this.createSponsorButton();
    this.createTierSelection();
    this.createFormInputs();
    this.createPreview();
  }

  createPreview() {
    // Clear previous preview
    if (this.previewContainer) {
      this.previewContainer.destroy(true);
    }

    const width = this.cameras.main.width;
    const height = this.cameras.main.height;
    let y = 570; // Below tier buttons

    // Create container
    this.previewContainer = this.add.container();
    this.previewContainer.setDepth(100);

    // === MOCK AD DATA ===
    const mockAd = {
      name: this.form.name || 'Sponsor Name',
      description: this.form.description || 'Short description here',
      cta: this.form.cta || 'CLICK HERE',
      website: this.form.website || 'https://example.com',
      logoUrl: this.form.logoUrl || this.mockLogoUrl,
      tier: this.selectedTier
    };
    console.log(this.form.name);

    // Determine size based on tier
    let w, h, scale;

    if (this.selectedTier === 'gold') {
      w = width - 100;
      h = 120;
      scale = 1.0;
    } else if (this.selectedTier === 'silver') {
      w = (width - 120) / 2;
      h = 120;
      scale = 1.0;
    } else {
      w = (width - 160) / 3;
      h = 120;
      scale = 1.0;
    }

    // X position: center if gold, left-aligned otherwise
    const x = width / 2;


    // Label
    const label = this.add.text(x, y, 'AD PREVIEW:', {
      fontFamily: 'Share Tech Mono',
      fontSize: '18px',
      fill: '#0f0'
    }).setOrigin(0.5);
    this.previewContainer.add(label);
    y += 90;

    // Reuse your renderSponsorAd
    this.renderSponsorAd(mockAd, w, h, x, y, scale);
  }
  
  renderSponsorAd(ad, w, h, x, y, scale) {
    const font = 'Share Tech Mono';
    const greenColor = '#0f0';
    const borderColor = 0x00ff00;

    // Background box
    const box = this.add.graphics();
    box.lineStyle(1, borderColor, 1);
    box.fillStyle(0x000000, 1);
    box.strokeRect(x - w / 2, y - h / 2, w, h);
    box.setDepth(5);
    this.previewContainer.add(box);

    // === CENTERED CONTENT GROUP ===
    const contentWidth = 280 * scale; // Estimate width of logo + name + desc
    const contentHeight = 80;
    const contentX = 80 + x - contentWidth / 2; // Left edge of content block
    const contentY = y - contentHeight / 2; // Top of content block

    // Logo size
    const logoSize = 36 * scale;

    // Logo: positioned at calculated left
    const logoX = contentX + logoSize / 2;
    const logo = this.add.image(logoX, contentY + 16, ad.logoUrl)
      .setDisplaySize(logoSize, logoSize)
      .setOrigin(0.5)
      .setDepth(6);
    this.previewContainer.add(logo);

    // Name: to the right of logo
    const nameX = contentX + logoSize + 10;
    const name = this.add.text(nameX, contentY + 8, ad.name, {
      fontFamily: font,
      fontSize: `${Math.floor(18 * scale)}px`,
      fill: '#0f0',
      stroke: '#003300',
      strokeThickness: 2
    }).setOrigin(0).setDepth(6);
    this.previewContainer.add(name);

    // Description: below logo
    const desc = this.add.text(logoX - logoSize / 2, contentY + 36, ad.description, {
      fontFamily: font,
      fontSize: `${Math.floor(12 * scale)}px`,
      fill: '#0f9',
      wordWrap: { width: w * 0.6 }
    }).setOrigin(0).setDepth(6);
    this.previewContainer.add(desc);

    // CTA Button – centered in ad box, below description
    const buttonWidth = w * 0.85;
    const buttonHeight = 28;
    const buttonX = x - buttonWidth / 2;
    const buttonY = y + 20;

    const button = this.add.graphics();
    button.fillStyle(0x00ff00, 1);
    button.fillRoundedRect(buttonX, buttonY, buttonWidth, buttonHeight, 6);
    button.setDepth(7);

    const buttonText = this.add.text(x, buttonY + buttonHeight / 2, ad.cta.toUpperCase(), {
      fontFamily: font,
      fontSize: '14px',
      fill: '#000',
      stroke: '#003300',
      strokeThickness: 1
    }).setOrigin(0.5).setDepth(8);

    // Interactive
    button.setInteractive(
      new Phaser.Geom.Rectangle(buttonX, buttonY, buttonWidth, buttonHeight),
      Phaser.Geom.Rectangle.Contains
    ).on('pointerdown', () => {
      window.open(ad.website, '_blank');
    });

    this.previewContainer.add(button);
    this.previewContainer.add(buttonText);
  }

  addEventListeners() {
    this.onSponsorResult = (e) => {
      const { success, message } = e.detail;

      if (success) {
        this.showSuccessAnimation('✨');
        this.statusText.setText(message).setColor('#00ff00');
      } else {
        this.statusText.setText(message).setColor('#ff0000');
      }

      this.time.delayedCall(4444, () => {
        this.statusText.setText('');
      });
    };

    document.addEventListener('sponsorize-result', this.onSponsorResult);
  }

  setupUI() {
    const width = this.cameras.main.width;
    const height = this.cameras.main.height;
    const green = '#0f0';
    const font = 'Share Tech Mono';

    // Background
    this.add.rectangle(width / 2, height / 2, width, height, 0x000000).setAlpha(0.9);

    // Title
    this.add.text(width / 2, 60, 'BECOME AN SPONSOR', {
      fontFamily: font,
      fontSize: '28px',
      fill: green
    }).setOrigin(0.5);

    // Connect Wallet Button
    this.connectBtn = this.add.text(width / 2, 120, 'CONNECT WALLET', {
      fontFamily: font,
      fontSize: '16px',
      fill: '#333',
      backgroundColor: green,
      padding: { x: 16, y: 8 }
    }).setOrigin(0.5).setInteractive({ useHandCursor: true });

    this.connectBtn.on('pointerdown', () => {
      document.dispatchEvent(new Event('open-wallet-modal'));
    });

    // Status text
    this.statusText = this.add.text(width / 2, height - 100, '', {
      fontFamily: font,
      fontSize: '20px',
      fill: green
    }).setOrigin(0.5);

    // Back button
    this.backBtn = this.add.text(width / 2, height - 40, 'BACK', {
      fontFamily: font,
      fontSize: '20px',
      fill: green
    }).setOrigin(0.5).setInteractive({ useHandCursor: true });

    this.backBtn.on('pointerdown', () => this.goBack());
  }

  createFormInputs() {
    const width = this.cameras.main.width;
    const startY = 200;
    const spacing = 50;
    const labelX = width * 0.25;
    const inputX = width * 0.65;
    const green = '#0f0';
    const font = 'Share Tech Mono';

    const labels = [
      'Sponsor Name:',
      'Short Desc:',
      'Call to Action:',
      'Logo URL (IPFS):',
      'Website:'
    ];

    const placeholders = [
      'Acme Corp',
      'Revolutionizing Web3 gaming',
      'Play Now',
      'ipfs://Qm...',
      'https://acmecorp.com'
    ];

    this.inputFields = [];

    labels.forEach((label, i) => {
      // Label
      this.add.text(labelX, startY + i * spacing, label, {
        fontFamily: font,
        fontSize: '16px',
        fill: green
      }).setOrigin(0.5);

      // Input box 
      const inputBg = this.add.rectangle(inputX, startY + i * spacing, 300, 32, 0x222222)
        .setOrigin(0.5)
        .setStrokeStyle(1, '0x00ff00');

      const inputText = this.add.text(inputX, startY + i * spacing, placeholders[i], {
        fontFamily: font,
        fontSize: '14px',
        fill: '#aaa'
      }).setOrigin(0.5).setInteractive({ useHandCursor: true });

      this.inputFields.push({
        bg: inputBg,
        text: inputText,
        placeholder: placeholders[i],
        value: '',
        active: false
      });

      // Click to focus
      inputText.on('pointerdown', () => {
        this.focusInput(i);
      });
    });

    // Make keyboard input work
    this.input.keyboard.on('keydown', (event) => {
      const focused = this.inputFields.find(f => f.active);
      if (!focused) return;

      const key = event.key;

      if (key === 'Backspace') {
        focused.value = focused.value.slice(0, -1);
      } else if (key.length === 1 && event.key !== 'Shift' && event.key !== 'Control') {
        focused.value += key;
      }

      switch (this.inputFields.indexOf(focused)) {
        case 0: this.form.name = focused.value; break;
        case 1: this.form.description = focused.value; break;
        case 2: this.form.cta = focused.value; break;
        case 3: break;
        case 4: this.form.website = focused.value; break;
      }

      this.updateInputDisplay(focused);
      this.createPreview();
    });
  }

  focusInput(index) {
    this.inputFields.forEach((field, i) => {
      field.active = i === index;
      field.text.setStyle({ fill: i === index ? '#00ff00' : '#aaa' });
    });
  }

  updateInputDisplay(field) {
    field.text.setText(field.value || field.placeholder);
  }

  createTierSelection() {
    const width = this.cameras.main.width;
    const y = 500;
    const font = 'Share Tech Mono';
    const tiers = ['bronze', 'silver', 'gold'];
    const colors = { bronze: '#CD7F32', silver: '#C0C0C0', gold: '#FFD700' };
    const prices = { gold: '0.01 ETH', silver: '0.00069 ETH', bronze: '0.00042 ETH' };

    this.tierButtons = {};

    tiers.forEach((tier, i) => {
      const x = width * 0.25 + (i+1) * 120;
      const btn = this.add.text(x, y, tier.toUpperCase(), {
        fontFamily: font,
        fontSize: '24px',
        fill: '#111',
        backgroundColor: colors[tier]
      }).setOrigin(0.5).setInteractive({ useHandCursor: true });
      const priceText = this.add.text(x, y + 25, prices[tier], {
        fontFamily: font,
        fontSize: '16px',
        fill: colors[tier]
      }).setOrigin(0.5);

      btn.on('pointerdown', () => {
        // Update selected
        this.selectedTier = tier;
        // Visual feedback
        Object.keys(this.tierButtons).forEach(t => {
          const b = this.tierButtons[t];
          b.setStyle({ backgroundColor: colors[t], fill: '#111' });
        });
        btn.setStyle({ backgroundColor: '#00ff00', fill: '#111' });
        
        this.createPreview();
      });

      this.tierButtons[tier] = btn;
    });

    // Default selection visual
    this.time.delayedCall(100, () => {
      this.tierButtons[this.selectedTier].setStyle({ backgroundColor: '#00ff00', fill: '#111' });
    });

    // Label
    this.add.text(width * 0.5, y - 40, 'SELECT SPONSORSHIP TIER:', {
      fontFamily: font,
      fontSize: '18px',
      fill: '#0f0'
    }).setOrigin(0.5);
  }

  createSponsorButton() {
    const width = this.cameras.main.width;
    const height = this.cameras.main.height;

    this.sponsorBtn = this.add.text(width / 2, 760, 'SUBMIT SPONSORSHIP', {
      fontFamily: 'Share Tech Mono',
      fontSize: '18px',
      fill: '#333',
      backgroundColor: '#0f0',
      padding: { x: 20, y: 10 }
    }).setOrigin(0.5).setAlpha(1);

    this.sponsorBtn.setInteractive({ useHandCursor: true }).on('pointerdown', () => {
      this.submitSponsorship();
    });
  }

  submitSponsorship() {
    // Gather all input values
    this.inputFields.forEach((field, i) => {
      switch (i) {
        case 0: this.form.name = field.value; break;
        case 1: this.form.description = field.value; break;
        case 2: this.form.cta = field.value; break;
        case 3: this.form.logoUrl = field.value; break;
        case 4: this.form.website = field.value; break;
      }
    });

    // Validate
    if (!this.form.name || !this.form.description || !this.form.cta || !this.form.logoUrl || !this.form.website) {
      this.statusText.setText('Please fill all fields.').setColor('#ff0000');
      return;
    }
/*
    if (!this.form.logoUrl.startsWith('ipfs://')) {
      this.statusText.setText('Logo URL must start with ipfs://').setColor('#ff0000');
      return;
    }
*/
    if (!this.form.website.startsWith('http://') && !this.form.website.startsWith('https://')) {
      this.statusText.setText('Website must be a valid URL.').setColor('#ff0000');
      return;
    }

    if (!this.setSponsorParams) {
      this.statusText.setText('Sponsor system not ready.').setColor('#ff0000');
      return;
    }

    // Set params for onchain call
    this.setSponsorParams({
      tier: this.selectedTier,
      name: this.form.name,
      description: this.form.description,
      cta: this.form.cta,
      logoUrl: this.form.logoUrl,
      website: this.form.website
    });

    this.statusText.setText('Submitting sponsorship... Confirm in wallet.').setColor('#00ff00');

    // Trigger the actual on-chain call
    this.time.delayedCall(1111, () => {
      document.getElementById('sponsor-trigger')?.click();
    });
  }

  showSuccessAnimation(particleEmoji) {
    const width = this.cameras.main.width;
    const height = this.cameras.main.height;

    for (let i = 0; i < 20; i++) {
      const x = Math.random() * width;
      const y = Math.random() * height;
      const particle = this.add.text(x, y, particleEmoji, { fontSize: '20px' }).setAlpha(0);

      this.tweens.add({
        targets: particle,
        y: y - 100,
        alpha: { from: 0, to: 1 },
        duration: 1111,
        ease: 'Power1',
        delay: Math.random() * 420,
        onComplete: () => particle.destroy()
      });
    }
  }

  goBack() {
    this.scene.stop();
    this.scene.resume('MainScene');
  }

  shutdown() {
    document.removeEventListener('sponsorize-result', this.onSponsorResult);
  }
}
